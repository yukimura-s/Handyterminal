<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>出庫管理システム</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 10px; background: #fff; color: #000; }
        .screen { display: none; } /* 初期状態はすべて非表示 */
        .active { display: block; } /* アクティブな画面のみ表示 */

        h2 { font-size: 1.2rem; border-bottom: 2px solid #000; padding-bottom: 5px; margin-bottom: 15px; }
        label { display: block; font-size: 0.9rem; font-weight: bold; margin-bottom: 5px; }
        
        input { 
            width: 100%; padding: 12px; font-size: 1.5rem; font-weight: bold;
            border: 2px solid #000; box-sizing: border-box; margin-bottom: 20px; 
        }

        /* メニューボタン */
        .menu-btn { 
            width: 100%; padding: 25px; font-size: 1.5rem; font-weight: bold;
            background: #fff; border: 3px solid #000; cursor: pointer; text-align: center;
        }

        /* 結果表示エリア */
        #result-area { display: none; padding: 10px; border: 2px solid #000; margin-top: 10px; }
        .ok { background: #d1ffd1; }
        .ng { background: #ffcccc; }
        #qty-display { display: none; text-align: center; font-size: 5rem; font-weight: bold; margin: 10px 0; }
        
        .footer-info { font-size: 1rem; border-top: 1px solid #000; padding-top: 10px; margin-top: 10px; }
        .btn-action { width: 100%; padding: 15px; font-weight: bold; margin-top: 20px; border: 2px solid #000; background: #fff; }
    </style>
</head>
<body>

    <div id="screen-login" class="screen active">
        <h2>作業者認証</h2>
        <label>名前コード(4桁)を入力してください</label>
        <input type="text" id="nameCode" inputmode="numeric" maxlength="4" placeholder="0000">
        <p style="font-size: 0.8rem;">※テスト用コード: 1111</p>
    </div>

    <div id="screen-menu" class="screen">
        <h2>メニュー選択</h2>
        <div class="menu-btn" onclick="goToShipping()">出庫作業</div>
        <p style="margin-top:20px; color:#666;">作業を選択してください</p>
    </div>

    <div id="screen-shipping" class="screen">
        <h2>出庫：照合スキャン</h2>
        <label>① 棚番号を入力</label>
        <input type="text" id="shelfInput" placeholder="棚番">

        <label>② 商品QRをスキャン</label>
        <input type="text" id="qrInput" placeholder="QRコード">

        <div id="result-area">
            <div id="status-text" style="text-align:center; font-weight:bold; font-size:1.5rem;"></div>
            <div id="qty-display">0</div>
            <div class="footer-info">
                品番：<span id="res-code"></span><br>
                ロケ：<span id="res-loc"></span>
            </div>
        </div>
        <button class="btn-action" onclick="downloadCSV()">作業完了(CSV保存)</button>
        <button class="btn-action" style="border:none; text-decoration:underline;" onclick="location.reload()">メニューに戻る</button>
    </div>

    <script>
        const nameCodeIn = document.getElementById('nameCode');
        const shelfIn = document.getElementById('shelfInput');
        const qrIn = document.getElementById('qrInput');
        let logs = [];

        // ログイン処理：1111を入力してENTを押すとメニューへ
        nameCodeIn.onkeydown = (e) => {
            if (e.key === 'Enter') {
                if (nameCodeIn.value === "1111") {
                    showScreen('screen-menu');
                } else {
                    alert("名前コードが違います");
                    nameCodeIn.value = "";
                }
            }
        };

        // メニューから出庫へ
        function goToShipping() {
            showScreen('screen-shipping');
            setTimeout(() => shelfIn.focus(), 100);
        }

        // 出庫画面の遷移
        shelfIn.onkeydown = (e) => { if(e.key === 'Enter') qrIn.focus(); };
        qrIn.onkeydown = (e) => { if(e.key === 'Enter') checkProcess(); };

        // 画面切り替え関数
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        // 照合ロジック
        function checkProcess() {
            const targetLoc = shelfIn.value.trim().toUpperCase();
            const qrData = qrIn.value.split(',');

            if (qrData.length < 5) {
                alert("QR形式エラー");
                return;
            }

            const pCode = qrData[2];
            const pQty  = qrData[3];
            const pLoc  = qrData[4].trim().toUpperCase();
            const isMatch = (targetLoc === pLoc);

            const resArea = document.getElementById('result-area');
            const qtyDisp = document.getElementById('qty-display');
            
            resArea.style.display = 'block';
            resArea.className = isMatch ? 'ok' : 'ng';
            document.getElementById('status-text').innerText = isMatch ? "【照合一致】" : "【照合NG】";
            document.getElementById('res-code').innerText = pCode;
            document.getElementById('res-loc').innerText = pLoc;

            if (isMatch) {
                qtyDisp.style.display = 'block';
                document.getElementById('qty-display').innerText = pQty;
                logs.push([pCode, "出庫", pLoc, targetLoc, new Date().toLocaleString(), "一致"].join(','));
                qrIn.value = "";
                qrIn.focus();
            } else {
                qtyDisp.style.display = 'none';
                setTimeout(() => {
                    resArea.style.display = 'none';
                    qrIn.value = "";
                    qrIn.focus();
                }, 2000);
            }
        }

        function downloadCSV() {
            if (logs.length === 0) return alert("データがありません");
            const content = "品番,タイプ,旧ロケ,新ロケ,日時,結果\n" + logs.join('\n');
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), content], {type: 'text/csv'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = "shukko_result.csv";
            a.click();
        }
    </script>
</body>
</html>
